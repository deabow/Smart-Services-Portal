{% extends 'base.html' %}

{% block title %}معالجة طلب استعادة كلمة المرور - لوحة التحكم{% endblock %}

{% block page_indicator %}
<div class="page-indicator">
	<i class="fas fa-user-shield"></i> معالجة طلب استعادة كلمة المرور
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
	<div class="row justify-content-center">
		<div class="col-md-10 col-lg-8">
			<!-- معلومات الطلب -->
			<div class="card border-0 shadow-sm mb-4">
				<div class="card-header bg-primary text-white">
					<h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>معلومات الطلب</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6 mb-3">
							<strong class="text-muted">المستخدم:</strong>
							<div class="mt-1">
								<strong>{{ reset_request.user.username }}</strong><br>
								<small class="text-muted">{{ reset_request.user.full_name|default:'-' }}</small><br>
								<small class="text-muted">{{ reset_request.user.email }}</small>
							</div>
						</div>
						<div class="col-md-6 mb-3">
							<strong class="text-muted">الرقم القومي المقدم:</strong>
							<div class="mt-1">{{ reset_request.national_id }}</div>
							<small class="text-muted">المسجل: {{ reset_request.user.national_id|default:'غير مسجل' }}</small>
						</div>
						<div class="col-md-6 mb-3">
							<strong class="text-muted">رقم الهاتف المقدم:</strong>
							<div class="mt-1">{{ reset_request.phone }}</div>
							<small class="text-muted">المسجل: {{ reset_request.user.phone|default:'غير مسجل' }}</small>
						</div>
						<div class="col-md-6 mb-3">
							<strong class="text-muted">الحالة:</strong>
							<div class="mt-1">
								{% if reset_request.status == 'pending' %}
									<span class="badge bg-warning text-dark">
										<i class="fas fa-clock me-1"></i>قيد الانتظار
									</span>
								{% elif reset_request.status == 'approved' %}
									<span class="badge bg-info text-white">
										<i class="fas fa-check me-1"></i>موافق عليه
									</span>
								{% elif reset_request.status == 'completed' %}
									<span class="badge bg-success text-white">
										<i class="fas fa-check-circle me-1"></i>مكتمل
									</span>
								{% elif reset_request.status == 'rejected' %}
									<span class="badge bg-danger text-white">
										<i class="fas fa-times me-1"></i>مرفوض
									</span>
								{% endif %}
							</div>
						</div>
						<div class="col-md-6 mb-3">
							<strong class="text-muted">تاريخ الطلب:</strong>
							<div class="mt-1">{{ reset_request.created_at|date:"Y/m/d H:i" }}</div>
						</div>
						{% if reset_request.handled_at %}
						<div class="col-md-6 mb-3">
							<strong class="text-muted">تاريخ المعالجة:</strong>
							<div class="mt-1">{{ reset_request.handled_at|date:"Y/m/d H:i" }}</div>
						</div>
						{% endif %}
						{% if reset_request.admin_user %}
						<div class="col-md-6 mb-3">
							<strong class="text-muted">المشرف المعالج:</strong>
							<div class="mt-1">{{ reset_request.admin_user.username }}</div>
						</div>
						{% endif %}
						{% if reset_request.reason %}
						<div class="col-12 mb-3">
							<strong class="text-muted">سبب الطلب:</strong>
							<div class="mt-1 p-2 bg-light rounded">{{ reset_request.reason }}</div>
						</div>
						{% endif %}
						{% if reset_request.admin_notes %}
						<div class="col-12 mb-3">
							<strong class="text-muted">ملاحظات المشرف:</strong>
							<div class="mt-1 p-2 bg-light rounded">{{ reset_request.admin_notes }}</div>
						</div>
						{% endif %}
					</div>
				</div>
			</div>

			<!-- التحقق من البيانات -->
			<div class="card border-0 shadow-sm mb-4">
				<div class="card-header bg-{% if reset_request.national_id == reset_request.user.national_id and reset_request.phone == reset_request.user.phone %}success{% else %}warning{% endif %} text-white">
					<h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>التحقق من البيانات</h5>
				</div>
				<div class="card-body">
					<ul class="list-unstyled mb-0">
						<li class="mb-2">
							<i class="fas fa-{% if reset_request.national_id == reset_request.user.national_id %}check text-success{% else %}times text-danger{% endif %} me-2"></i>
							الرقم القومي: 
							{% if reset_request.national_id == reset_request.user.national_id %}
								<span class="text-success">متطابق ✓</span>
							{% else %}
								<span class="text-danger">غير متطابق ✗</span>
							{% endif %}
						</li>
						<li>
							<i class="fas fa-{% if reset_request.phone == reset_request.user.phone %}check text-success{% else %}times text-danger{% endif %} me-2"></i>
							رقم الهاتف: 
							{% if reset_request.phone == reset_request.user.phone %}
								<span class="text-success">متطابق ✓</span>
							{% else %}
								<span class="text-danger">غير متطابق ✗</span>
							{% endif %}
						</li>
					</ul>
				</div>
			</div>

			<!-- إجراءات المعالجة -->
			{% if reset_request.status == 'pending' %}
			<div class="card border-0 shadow-sm mb-4">
				<div class="card-header bg-warning text-dark">
					<h5 class="mb-0"><i class="fas fa-cog me-2"></i>معالجة الطلب</h5>
				</div>
				<div class="card-body">
					<form method="post" class="mb-3">
						{% csrf_token %}
						<input type="hidden" name="action" value="approve">
						
						<div class="mb-3">
							<label for="notes_approve" class="form-label">ملاحظات (اختياري)</label>
							<textarea class="form-control" id="notes_approve" name="notes" rows="2" 
									  placeholder="أضف ملاحظات حول الموافقة على الطلب"></textarea>
						</div>
						
						<button type="submit" class="btn btn-info">
							<i class="fas fa-check me-2"></i>الموافقة على الطلب
						</button>
					</form>

					<hr>

					<form method="post">
						{% csrf_token %}
						<input type="hidden" name="action" value="reject">
						
						<div class="mb-3">
							<label for="notes_reject" class="form-label">سبب الرفض *</label>
							<textarea class="form-control" id="notes_reject" name="notes" rows="2" 
									  placeholder="اذكر سبب رفض الطلب" required></textarea>
						</div>
						
						<button type="submit" class="btn btn-danger">
							<i class="fas fa-times me-2"></i>رفض الطلب
						</button>
					</form>
				</div>
			</div>
			{% endif %}

			<!-- إعادة تعيين كلمة المرور -->
			{% if reset_request.status == 'approved' or reset_request.status == 'pending' %}
			<div class="card border-0 shadow-sm mb-4">
				<div class="card-header bg-primary text-white">
					<h5 class="mb-0"><i class="fas fa-key me-2"></i>إعادة تعيين كلمة المرور</h5>
				</div>
				<div class="card-body">
					<form method="post" id="resetPasswordForm">
						{% csrf_token %}
						<input type="hidden" name="action" value="complete">
						
						<div class="mb-3">
							<label for="new_password" class="form-label">كلمة المرور الجديدة *</label>
							<input type="password" class="form-control" id="new_password" name="new_password" 
								   placeholder="أدخل كلمة مرور جديدة (8 أحرف على الأقل)" minlength="8" required>
							<div class="form-text">كلمة المرور يجب أن تكون 8 أحرف على الأقل</div>
						</div>
						
						<div class="mb-3">
							<label for="confirm_password" class="form-label">تأكيد كلمة المرور *</label>
							<input type="password" class="form-control" id="confirm_password" 
								   placeholder="أعد إدخال كلمة المرور" required>
							<div id="passwordMatch" class="form-text"></div>
						</div>
						
						<div class="mb-3">
							<label for="notes_complete" class="form-label">ملاحظات (اختياري)</label>
							<textarea class="form-control" id="notes_complete" name="notes" rows="2" 
									  placeholder="أضف ملاحظات حول إعادة تعيين كلمة المرور"></textarea>
						</div>
						
						<button type="submit" class="btn btn-success" id="submitBtn">
							<i class="fas fa-key me-2"></i>إعادة تعيين كلمة المرور وإنهاء الطلب
						</button>
					</form>
				</div>
			</div>
			{% endif %}

			<!-- إعادة تعيين سريع (بدون إنهاء الطلب) -->
			{% if reset_request.status != 'completed' %}
			<div class="card border-0 shadow-sm mb-4">
				<div class="card-header bg-secondary text-white">
					<h5 class="mb-0"><i class="fas fa-bolt me-2"></i>إعادة تعيين سريع</h5>
				</div>
				<div class="card-body">
					<form method="post" id="quickResetForm">
						{% csrf_token %}
						<input type="hidden" name="action" value="reset_password">
						
						<div class="mb-3">
							<label for="quick_password" class="form-label">كلمة المرور الجديدة *</label>
							<input type="password" class="form-control" id="quick_password" name="new_password" 
								   placeholder="أدخل كلمة مرور جديدة (8 أحرف على الأقل)" minlength="8" required>
							<div class="form-text">سيتم إعادة تعيين كلمة المرور فقط دون تغيير حالة الطلب</div>
						</div>
						
						<button type="submit" class="btn btn-secondary">
							<i class="fas fa-bolt me-2"></i>إعادة تعيين فقط
						</button>
					</form>
				</div>
			</div>
			{% endif %}

			<!-- الرجوع -->
			<div class="text-center">
				<a href="{% url 'users:password_reset_admin' %}" class="btn btn-outline-primary">
					<i class="fas fa-arrow-right me-2"></i>الرجوع لقائمة الطلبات
				</a>
			</div>
		</div>
	</div>
</div>

<script>
// التحقق من تطابق كلمة المرور
document.getElementById('confirm_password')?.addEventListener('input', function() {
	const password = document.getElementById('new_password').value;
	const confirm = this.value;
	const matchDiv = document.getElementById('passwordMatch');
	const submitBtn = document.getElementById('submitBtn');
	
	if (confirm) {
		if (password === confirm) {
			matchDiv.innerHTML = '<span class="text-success"><i class="fas fa-check me-1"></i>كلمة المرور متطابقة</span>';
			if (submitBtn) submitBtn.disabled = false;
		} else {
			matchDiv.innerHTML = '<span class="text-danger"><i class="fas fa-times me-1"></i>كلمة المرور غير متطابقة</span>';
			if (submitBtn) submitBtn.disabled = true;
		}
	} else {
		matchDiv.innerHTML = '';
		if (submitBtn) submitBtn.disabled = false;
	}
});
</script>
{% endblock %}

