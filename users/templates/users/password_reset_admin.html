{% extends 'base.html' %}

{% block title %}إدارة طلبات استعادة كلمة المرور - لوحة التحكم{% endblock %}

{% block page_indicator %}
<div class="page-indicator">
	<i class="fas fa-user-shield"></i> إدارة طلبات استعادة كلمة المرور
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
	<!-- الإحصائيات -->
	<div class="row g-3 mb-4">
		<div class="col-md-3">
			<div class="card border-0 shadow-sm">
				<div class="card-body text-center">
					<div class="h2 text-primary">{{ stats.total }}</div>
					<div class="text-muted">إجمالي الطلبات</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card border-0 shadow-sm border-warning">
				<div class="card-body text-center">
					<div class="h2 text-warning">{{ stats.pending }}</div>
					<div class="text-muted">قيد الانتظار</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card border-0 shadow-sm border-success">
				<div class="card-body text-center">
					<div class="h2 text-success">{{ stats.completed }}</div>
					<div class="text-muted">مكتملة</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card border-0 shadow-sm border-danger">
				<div class="card-body text-center">
					<div class="h2 text-danger">{{ stats.rejected }}</div>
					<div class="text-muted">مرفوضة</div>
				</div>
			</div>
		</div>
	</div>

	<!-- الفلترة -->
	<div class="card border-0 shadow-sm mb-4">
		<div class="card-body">
			<div class="d-flex gap-2 flex-wrap">
				<a href="?status=" class="btn btn-{% if not current_status %}primary{% else %}outline-primary{% endif %}">
					الكل ({{ stats.total }})
				</a>
				<a href="?status=pending" class="btn btn-{% if current_status == 'pending' %}warning{% else %}outline-warning{% endif %}">
					قيد الانتظار ({{ stats.pending }})
				</a>
				<a href="?status=approved" class="btn btn-{% if current_status == 'approved' %}info{% else %}outline-info{% endif %}">
					موافق عليه ({{ stats.approved }})
				</a>
				<a href="?status=completed" class="btn btn-{% if current_status == 'completed' %}success{% else %}outline-success{% endif %}">
					مكتملة ({{ stats.completed }})
				</a>
				<a href="?status=rejected" class="btn btn-{% if current_status == 'rejected' %}danger{% else %}outline-danger{% endif %}">
					مرفوضة ({{ stats.rejected }})
				</a>
			</div>
		</div>
	</div>

	<!-- قائمة الطلبات -->
	<div class="card border-0 shadow-sm">
		<div class="card-header bg-primary text-white">
			<h5 class="mb-0"><i class="fas fa-list me-2"></i>طلبات استعادة كلمة المرور</h5>
		</div>
		<div class="card-body p-0">
			{% if requests %}
			<div class="table-responsive">
				<table class="table table-hover mb-0">
					<thead class="table-light">
						<tr>
							<th>#</th>
							<th>المستخدم</th>
							<th>الرقم القومي</th>
							<th>رقم الهاتف</th>
							<th>تاريخ الطلب</th>
							<th>الحالة</th>
							<th>المشرف المعالج</th>
							<th>الإجراءات</th>
						</tr>
					</thead>
					<tbody>
						{% for req in requests %}
						<tr>
							<td>{{ req.id }}</td>
							<td>
								<div>
									<strong>{{ req.user.username }}</strong><br>
									<small class="text-muted">{{ req.user.full_name|default:'-' }}</small><br>
									<small class="text-muted">{{ req.user.email }}</small>
								</div>
							</td>
							<td>{{ req.national_id }}</td>
							<td>{{ req.phone }}</td>
							<td>
								<small>{{ req.created_at|date:"Y/m/d" }}</small><br>
								<small class="text-muted">{{ req.created_at|date:"H:i" }}</small>
							</td>
							<td>
								{% if req.status == 'pending' %}
									<span class="badge bg-warning text-dark">
										<i class="fas fa-clock me-1"></i>قيد الانتظار
									</span>
								{% elif req.status == 'approved' %}
									<span class="badge bg-info text-white">
										<i class="fas fa-check me-1"></i>موافق عليه
									</span>
								{% elif req.status == 'completed' %}
									<span class="badge bg-success text-white">
										<i class="fas fa-check-circle me-1"></i>مكتمل
									</span>
								{% elif req.status == 'rejected' %}
									<span class="badge bg-danger text-white">
										<i class="fas fa-times me-1"></i>مرفوض
									</span>
								{% endif %}
							</td>
							<td>
								{% if req.admin_user %}
									{{ req.admin_user.username }}<br>
									<small class="text-muted">{{ req.handled_at|date:"Y/m/d H:i" }}</small>
								{% else %}
									<span class="text-muted">-</span>
								{% endif %}
							</td>
							<td>
								<a href="{% url 'users:password_reset_admin_handle' req.id %}" class="btn btn-sm btn-primary">
									<i class="fas fa-eye me-1"></i>عرض
								</a>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
			{% else %}
			<div class="text-center p-5">
				<i class="fas fa-inbox fa-3x text-muted mb-3"></i>
				<p class="text-muted">لا توجد طلبات</p>
			</div>
			{% endif %}
		</div>
	</div>
</div>
{% endblock %}

