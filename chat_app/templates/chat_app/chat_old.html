{% extends 'base.html' %}

{% block title %}Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø°ÙƒÙŠØ© - Ø§Ù„Ù†Ø§Ø¦Ø¨ Ø£Ø­Ù…Ø¯ Ø£Ø¨Ùˆ Ø²ÙŠØ¯{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Ø´Ø±ÙŠØ· Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ğŸ¤– Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="chat-avatar">
                            <i class="fas fa-robot fa-3x text-primary"></i>
                        </div>
                        <h6 class="mt-2">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ</h6>
                        <small class="text-muted">Ù…ØªØ§Ø­ 24/7</small>
                    </div>
                    
                    <div class="help-section">
                        <h6 class="text-primary">ğŸ’¡ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</li>
                            <li><i class="fas fa-check text-success"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</li>
                            <li><i class="fas fa-check text-success"></i> Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª</li>
                            <li><i class="fas fa-check text-success"></i> ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</li>
                        </ul>
                    </div>
                    
                    <div class="quick-actions mt-3">
                        <h6 class="text-primary">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©:</h6>
                        <button class="btn btn-outline-primary btn-sm btn-block mb-2" onclick="sendQuickMessage('Ø£Ø±ÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨')">
                            ğŸ“ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                        </button>
                        <button class="btn btn-outline-info btn-sm btn-block mb-2" onclick="sendQuickMessage('Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙŠ')">
                            ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                        </button>
                        <button class="btn btn-outline-warning btn-sm btn-block mb-2" onclick="sendQuickMessage('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…ÙŠØ§Ù‡')">
                            ğŸ’§ Ù…Ø´ÙƒÙ„Ø© Ù…ÙŠØ§Ù‡
                        </button>
                        <button class="btn btn-outline-danger btn-sm btn-block mb-2" onclick="sendQuickMessage('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡')">
                            âš¡ Ù…Ø´ÙƒÙ„Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡
                        </button>
                        <button class="btn btn-outline-secondary btn-sm btn-block mb-2" onclick="sendQuickMessage('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø·Ø±Ù‚')">
                            ğŸ›£ï¸ Ù…Ø´ÙƒÙ„Ø© Ø·Ø±Ù‚
                        </button>
                        <button class="btn btn-outline-success btn-sm btn-block mb-2" onclick="sendQuickMessage('Ù…Ø³Ø§Ø¹Ø¯Ø©')">
                            â“ Ù…Ø³Ø§Ø¹Ø¯Ø©
                        </button>
                    </div>
                    
                    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
                    <div class="stats-section mt-3">
                        <h6 class="text-primary">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ:</h6>
                        <div class="stat-item">
                            <small class="text-muted">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</small>
                            <span class="badge bg-success" id="completed-count">-</span>
                        </div>
                        <div class="stat-item">
                            <small class="text-muted">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©:</small>
                            <span class="badge bg-warning" id="pending-count">-</span>
                        </div>
                        <div class="stat-item">
                            <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</small>
                            <span class="badge bg-primary" id="total-count">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="col-md-9">
            <div class="card chat-container">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
                    </h5>
                    <div class="chat-status">
                        <span class="badge bg-success">Ù…ØªØµÙ„</span>
                    </div>
                </div>
                
                <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
                <div class="card-body p-0">
                    <div id="messages-container" class="messages-container">
                        {% for message in messages %}
                        <div class="message {% if message.message_type == 'user' %}user-message{% else %}bot-message{% endif %}">
                            <div class="message-content">
                                {% if message.message_type == 'user' %}
                                <div class="message-bubble user-bubble">
                                    <p>{{ message.content|linebreaks }}</p>
                                    <small class="message-time">{{ message.created_at|date:"H:i" }}</small>
                                </div>
                                {% else %}
                                <div class="message-bubble bot-bubble">
                                    <div class="bot-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-text">
                                        <p>{{ message.content|linebreaks }}</p>
                                        <small class="message-time">{{ message.created_at|date:"H:i" }}</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." maxlength="1000">
                        <button class="btn btn-primary" id="send-button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-help mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Ø§Ø¶ØºØ· Enter Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø±Ø³Ù…ÙŠ Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©ØŸ</p>
                <div id="request-details"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" id="approve-request-btn">Ù†Ø¹Ù…ØŒ Ø£Ù†Ø´Ø¦ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
        </div>
    </div>
</div>

<style>
.chat-container {
    height: 600px;
    display: flex;
    flex-direction: column;
}

.messages-container {
    height: 500px;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 15px;
    display: flex;
}

.user-message {
    justify-content: flex-end;
}

.bot-message {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
}

.user-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 5px;
}

.bot-bubble {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 5px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.bot-avatar {
    background: #007bff;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.message-text {
    flex: 1;
}

.message-time {
    opacity: 0.7;
    font-size: 0.8em;
}

.help-section ul li {
    margin-bottom: 5px;
}

.quick-actions .btn {
    font-size: 0.9em;
}

.chat-avatar {
    background: linear-gradient(135deg, #007bff, #0056b3);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    color: white;
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
[data-theme="dark"] .messages-container {
    background: #2d3748;
}

[data-theme="dark"] .bot-bubble {
    background: #4a5568;
    color: #e2e8f0;
    border-color: #718096;
}

[data-theme="dark"] .card {
    background: #2d3748;
    border-color: #4a5568;
}

[data-theme="dark"] .card-body {
    background: #2d3748;
    color: #e2e8f0;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {
    .col-md-3 {
        display: none;
    }
    
    .message-bubble {
        max-width: 85%;
    }
    
    .chat-container {
        height: 500px;
    }
    
    .messages-container {
        height: 400px;
    }
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ© */
.message {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© */
.typing-indicator .typing-dots {
    display: flex;
    gap: 4px;
    align-items: center;
}

.typing-indicator .typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #007bff;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator .typing-dots span:nth-child(1) {
    animation-delay: -0.32s;
}

.typing-indicator .typing-dots span:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.stats-section {
    background: var(--card-bg, #f8f9fa);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid var(--card-border, #e9ecef);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.stat-item:last-child {
    margin-bottom: 0;
}

.stat-item .badge {
    font-size: 0.8em;
    padding: 4px 8px;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
.quick-actions .btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.quick-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.quick-actions .btn:active {
    transform: translateY(0);
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.message {
    transition: all 0.3s ease;
}

.message:hover {
    transform: translateX(2px);
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
[data-theme="dark"] .stats-section {
    --card-bg: #2d3748;
    --card-border: #4a5568;
}

[data-theme="dark"] .stat-item small {
    color: #a0aec0;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 768px) {
    .stats-section {
        display: none;
    }
    
    .quick-actions .btn {
        font-size: 0.8em;
        padding: 6px 12px;
    }
}

/* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
.chat-container {
    position: relative;
}

.chat-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #007bff, #28a745, #ffc107, #dc3545);
    animation: rainbow 3s linear infinite;
}

@keyframes rainbow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù†Øµ */
.message-text p {
    line-height: 1.6;
    margin-bottom: 0;
}

.message-text strong {
    color: var(--text-primary, #007bff);
    font-weight: 600;
}

.message-text code {
    background: var(--code-bg, #f8f9fa);
    color: var(--code-color, #e83e8c);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù„Ù„Ù†Øµ */
[data-theme="dark"] .message-text code {
    --code-bg: #4a5568;
    --code-color: #f7fafc;
}

[data-theme="dark"] .message-text strong {
    --text-primary: #63b3ed;
}
</style>

<script>
let currentChatRequestId = null;

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content) return;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
    addMessageToUI(content, 'user');
    input.value = '';
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
    fetch('/chat/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
            addMessageToUI(data.bot_response.content, 'bot', data.bot_response);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø²Ø±Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø©
            if (data.bot_response.show_approval_buttons) {
                currentChatRequestId = data.bot_response.chat_request_id;
                showApprovalButtons();
            }
        } else {
            addMessageToUI('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'bot');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addMessageToUI('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.', 'bot');
    });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø©
function sendQuickMessage(message) {
    document.getElementById('message-input').value = message;
    sendMessage();
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
function addMessageToUI(content, type, botResponse = null) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString('ar-EG', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble user-bubble">
                    <p>${content.replace(/\n/g, '<br>')}</p>
                    <small class="message-time">${timeString}</small>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble bot-bubble">
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-text">
                        <p>${content.replace(/\n/g, '<br>')}</p>
                        <small class="message-time">${timeString}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

// Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
function showApprovalButtons() {
    const container = document.getElementById('messages-container');
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'message bot-message';
    buttonsDiv.innerHTML = `
        <div class="message-content">
            <div class="message-bubble bot-bubble">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-text">
                    <div class="approval-buttons">
                        <button class="btn btn-success btn-sm me-2" onclick="approveRequest(true)">
                            <i class="fas fa-check"></i> Ù†Ø¹Ù…
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="approveRequest(false)">
                            <i class="fas fa-times"></i> Ù„Ø§
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(buttonsDiv);
    container.scrollTop = container.scrollHeight;
}

// Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨
function approveRequest(approved) {
    if (!currentChatRequestId) return;
    
    fetch('/chat/approve-request/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 
            chat_request_id: currentChatRequestId,
            approved: approved 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
            addMessageToUI(data.bot_response.content, 'bot');
            
            if (approved && data.tracking_number) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹
                setTimeout(() => {
                    addMessageToUI(
                        `ğŸ‰ Ø±Ù‚Ù… ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ: **${data.tracking_number}**\n\nÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª!`, 
                        'bot'
                    );
                }, 1000);
            }
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
        const buttons = document.querySelectorAll('.approval-buttons');
        buttons.forEach(btn => btn.remove());
        
        currentChatRequestId = null;
    })
    .catch(error => {
        console.error('Error:', error);
        addMessageToUI('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨.', 'bot');
    });
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø³ÙÙ„
function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

// Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', function() {
    scrollToBottom();
    loadUserStats();
});

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function loadUserStats() {
    fetch('/chat/get-stats/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatsDisplay(data.stats);
        }
    })
    .catch(error => {
        console.error('Error loading stats:', error);
        // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        showDefaultStats();
    });
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function updateStatsDisplay(stats) {
    document.getElementById('completed-count').textContent = stats.completed_requests;
    document.getElementById('pending-count').textContent = stats.pending_requests;
    document.getElementById('total-count').textContent = stats.total_requests;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ©
    animateStats();
}

// Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
function showDefaultStats() {
    document.getElementById('completed-count').textContent = '0';
    document.getElementById('pending-count').textContent = '0';
    document.getElementById('total-count').textContent = '0';
}

// ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
function animateStats() {
    const badges = document.querySelectorAll('.stats-section .badge');
    badges.forEach((badge, index) => {
        badge.style.opacity = '0';
        badge.style.transform = 'scale(0.8)';
        
        setTimeout(() => {
            badge.style.transition = 'all 0.5s ease';
            badge.style.opacity = '1';
            badge.style.transform = 'scale(1)';
        }, index * 200);
    });
}

// Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø¨ÙˆØª
function addTypingIndicator() {
    const container = document.getElementById('messages-container');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-content">
            <div class="message-bubble bot-bubble">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-text">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

// Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// ØªØ­Ø³ÙŠÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content) return;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
    addMessageToUI(content, 'user');
    input.value = '';
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
    addTypingIndicator();
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
    fetch('/chat/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
        removeTypingIndicator();
        
        if (data.success) {
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
            addMessageToUI(data.bot_response.content, 'bot', data.bot_response);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø²Ø±Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø©
            if (data.bot_response.show_approval_buttons) {
                currentChatRequestId = data.bot_response.chat_request_id;
                showApprovalButtons();
            }
        } else {
            addMessageToUI('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'bot');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        console.error('Error:', error);
        addMessageToUI('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.', 'bot');
    });
}

// ØªØ­Ø³ÙŠÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±Ø§Øª
function addMessageToUI(content, type, botResponse = null) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString('ar-EG', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble user-bubble">
                    <p>${content.replace(/\n/g, '<br>')}</p>
                    <small class="message-time">${timeString}</small>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble bot-bubble">
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-text">
                        <p>${content.replace(/\n/g, '<br>')}</p>
                        <small class="message-time">${timeString}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.appendChild(messageDiv);
    
    // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ±
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
    }, 100);
    
    container.scrollTop = container.scrollHeight;
}
</script>
{% endblock %}
