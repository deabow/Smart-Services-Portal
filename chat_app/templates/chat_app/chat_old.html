{% extends 'base.html' %}

{% block title %}الدردشة الذكية - النائب أحمد أبو زيد{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- شريط جانبي للمعلومات -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">🤖 المساعد الذكي</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="chat-avatar">
                            <i class="fas fa-robot fa-3x text-primary"></i>
                        </div>
                        <h6 class="mt-2">مساعدك الذكي</h6>
                        <small class="text-muted">متاح 24/7</small>
                    </div>
                    
                    <div class="help-section">
                        <h6 class="text-primary">💡 يمكنني مساعدتك في:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> تقديم طلبات جديدة</li>
                            <li><i class="fas fa-check text-success"></i> متابعة حالة الطلبات</li>
                            <li><i class="fas fa-check text-success"></i> الإجابة على الاستفسارات</li>
                            <li><i class="fas fa-check text-success"></i> توجيهك للخدمات المناسبة</li>
                        </ul>
                    </div>
                    
                    <div class="quick-actions mt-3">
                        <h6 class="text-primary">⚡ إجراءات سريعة:</h6>
                        <button class="btn btn-outline-primary btn-sm btn-block mb-2" onclick="sendQuickMessage('أريد تقديم طلب')">
                            📝 طلب جديد
                        </button>
                        <button class="btn btn-outline-info btn-sm btn-block mb-2" onclick="sendQuickMessage('حالة طلباتي')">
                            📊 حالة الطلبات
                        </button>
                        <button class="btn btn-outline-warning btn-sm btn-block mb-2" onclick="sendQuickMessage('مشكلة في المياه')">
                            💧 مشكلة مياه
                        </button>
                        <button class="btn btn-outline-danger btn-sm btn-block mb-2" onclick="sendQuickMessage('مشكلة في الكهرباء')">
                            ⚡ مشكلة كهرباء
                        </button>
                        <button class="btn btn-outline-secondary btn-sm btn-block mb-2" onclick="sendQuickMessage('مشكلة في الطرق')">
                            🛣️ مشكلة طرق
                        </button>
                        <button class="btn btn-outline-success btn-sm btn-block mb-2" onclick="sendQuickMessage('مساعدة')">
                            ❓ مساعدة
                        </button>
                    </div>
                    
                    <!-- إحصائيات سريعة -->
                    <div class="stats-section mt-3">
                        <h6 class="text-primary">📈 إحصائياتك:</h6>
                        <div class="stat-item">
                            <small class="text-muted">الطلبات المكتملة:</small>
                            <span class="badge bg-success" id="completed-count">-</span>
                        </div>
                        <div class="stat-item">
                            <small class="text-muted">الطلبات قيد المراجعة:</small>
                            <span class="badge bg-warning" id="pending-count">-</span>
                        </div>
                        <div class="stat-item">
                            <small class="text-muted">إجمالي الطلبات:</small>
                            <span class="badge bg-primary" id="total-count">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- منطقة الدردشة الرئيسية -->
        <div class="col-md-9">
            <div class="card chat-container">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        الدردشة مع المساعد الذكي
                    </h5>
                    <div class="chat-status">
                        <span class="badge bg-success">متصل</span>
                    </div>
                </div>
                
                <!-- منطقة الرسائل -->
                <div class="card-body p-0">
                    <div id="messages-container" class="messages-container">
                        {% for message in messages %}
                        <div class="message {% if message.message_type == 'user' %}user-message{% else %}bot-message{% endif %}">
                            <div class="message-content">
                                {% if message.message_type == 'user' %}
                                <div class="message-bubble user-bubble">
                                    <p>{{ message.content|linebreaks }}</p>
                                    <small class="message-time">{{ message.created_at|date:"H:i" }}</small>
                                </div>
                                {% else %}
                                <div class="message-bubble bot-bubble">
                                    <div class="bot-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-text">
                                        <p>{{ message.content|linebreaks }}</p>
                                        <small class="message-time">{{ message.created_at|date:"H:i" }}</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- منطقة إدخال الرسالة -->
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="اكتب رسالتك هنا..." maxlength="1000">
                        <button class="btn btn-primary" id="send-button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-help mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            اضغط Enter لإرسال الرسالة
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal للموافقة على الطلب -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تأكيد إنشاء الطلب</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>هل تريد إنشاء طلب رسمي بالتفاصيل المقترحة؟</p>
                <div id="request-details"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="approve-request-btn">نعم، أنشئ الطلب</button>
            </div>
        </div>
    </div>
</div>

<style>
.chat-container {
    height: 600px;
    display: flex;
    flex-direction: column;
}

.messages-container {
    height: 500px;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 15px;
    display: flex;
}

.user-message {
    justify-content: flex-end;
}

.bot-message {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
}

.user-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 5px;
}

.bot-bubble {
    background: white;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 5px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.bot-avatar {
    background: #007bff;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.message-text {
    flex: 1;
}

.message-time {
    opacity: 0.7;
    font-size: 0.8em;
}

.help-section ul li {
    margin-bottom: 5px;
}

.quick-actions .btn {
    font-size: 0.9em;
}

.chat-avatar {
    background: linear-gradient(135deg, #007bff, #0056b3);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    color: white;
}

/* الوضع الليلي */
[data-theme="dark"] .messages-container {
    background: #2d3748;
}

[data-theme="dark"] .bot-bubble {
    background: #4a5568;
    color: #e2e8f0;
    border-color: #718096;
}

[data-theme="dark"] .card {
    background: #2d3748;
    border-color: #4a5568;
}

[data-theme="dark"] .card-body {
    background: #2d3748;
    color: #e2e8f0;
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .col-md-3 {
        display: none;
    }
    
    .message-bubble {
        max-width: 85%;
    }
    
    .chat-container {
        height: 500px;
    }
    
    .messages-container {
        height: 400px;
    }
}

/* تأثيرات الحركة */
.message {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* تحسين شريط التمرير */
.messages-container::-webkit-scrollbar {
    width: 6px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* مؤشر الكتابة */
.typing-indicator .typing-dots {
    display: flex;
    gap: 4px;
    align-items: center;
}

.typing-indicator .typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #007bff;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator .typing-dots span:nth-child(1) {
    animation-delay: -0.32s;
}

.typing-indicator .typing-dots span:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* إحصائيات المستخدم */
.stats-section {
    background: var(--card-bg, #f8f9fa);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid var(--card-border, #e9ecef);
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.stat-item:last-child {
    margin-bottom: 0;
}

.stat-item .badge {
    font-size: 0.8em;
    padding: 4px 8px;
}

/* تحسينات الأزرار السريعة */
.quick-actions .btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.quick-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.quick-actions .btn:active {
    transform: translateY(0);
}

/* تأثيرات الرسائل */
.message {
    transition: all 0.3s ease;
}

.message:hover {
    transform: translateX(2px);
}

/* تحسينات للوضع الليلي */
[data-theme="dark"] .stats-section {
    --card-bg: #2d3748;
    --card-border: #4a5568;
}

[data-theme="dark"] .stat-item small {
    color: #a0aec0;
}

/* تحسينات للجوال */
@media (max-width: 768px) {
    .stats-section {
        display: none;
    }
    
    .quick-actions .btn {
        font-size: 0.8em;
        padding: 6px 12px;
    }
}

/* تأثيرات إضافية */
.chat-container {
    position: relative;
}

.chat-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #007bff, #28a745, #ffc107, #dc3545);
    animation: rainbow 3s linear infinite;
}

@keyframes rainbow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* تحسينات النص */
.message-text p {
    line-height: 1.6;
    margin-bottom: 0;
}

.message-text strong {
    color: var(--text-primary, #007bff);
    font-weight: 600;
}

.message-text code {
    background: var(--code-bg, #f8f9fa);
    color: var(--code-color, #e83e8c);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

/* الوضع الليلي للنص */
[data-theme="dark"] .message-text code {
    --code-bg: #4a5568;
    --code-color: #f7fafc;
}

[data-theme="dark"] .message-text strong {
    --text-primary: #63b3ed;
}
</style>

<script>
let currentChatRequestId = null;

// إرسال رسالة
function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content) return;
    
    // إضافة الرسالة للواجهة فوراً
    addMessageToUI(content, 'user');
    input.value = '';
    
    // إرسال الرسالة للخادم
    fetch('/chat/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // إضافة رد البوت
            addMessageToUI(data.bot_response.content, 'bot', data.bot_response);
            
            // إذا كان هناك أزرار موافقة
            if (data.bot_response.show_approval_buttons) {
                currentChatRequestId = data.bot_response.chat_request_id;
                showApprovalButtons();
            }
        } else {
            addMessageToUI('عذراً، حدث خطأ. حاول مرة أخرى.', 'bot');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addMessageToUI('عذراً، حدث خطأ في الاتصال.', 'bot');
    });
}

// إرسال رسالة سريعة
function sendQuickMessage(message) {
    document.getElementById('message-input').value = message;
    sendMessage();
}

// إضافة رسالة للواجهة
function addMessageToUI(content, type, botResponse = null) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString('ar-EG', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble user-bubble">
                    <p>${content.replace(/\n/g, '<br>')}</p>
                    <small class="message-time">${timeString}</small>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble bot-bubble">
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-text">
                        <p>${content.replace(/\n/g, '<br>')}</p>
                        <small class="message-time">${timeString}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

// إظهار أزرار الموافقة
function showApprovalButtons() {
    const container = document.getElementById('messages-container');
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'message bot-message';
    buttonsDiv.innerHTML = `
        <div class="message-content">
            <div class="message-bubble bot-bubble">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-text">
                    <div class="approval-buttons">
                        <button class="btn btn-success btn-sm me-2" onclick="approveRequest(true)">
                            <i class="fas fa-check"></i> نعم
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="approveRequest(false)">
                            <i class="fas fa-times"></i> لا
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(buttonsDiv);
    container.scrollTop = container.scrollHeight;
}

// الموافقة على الطلب
function approveRequest(approved) {
    if (!currentChatRequestId) return;
    
    fetch('/chat/approve-request/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 
            chat_request_id: currentChatRequestId,
            approved: approved 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // إضافة رد البوت
            addMessageToUI(data.bot_response.content, 'bot');
            
            if (approved && data.tracking_number) {
                // إظهار رقم التتبع
                setTimeout(() => {
                    addMessageToUI(
                        `🎉 رقم تتبع طلبك: **${data.tracking_number}**\n\nيمكنك متابعة طلبك في أي وقت!`, 
                        'bot'
                    );
                }, 1000);
            }
        }
        
        // إخفاء أزرار الموافقة
        const buttons = document.querySelectorAll('.approval-buttons');
        buttons.forEach(btn => btn.remove());
        
        currentChatRequestId = null;
    })
    .catch(error => {
        console.error('Error:', error);
        addMessageToUI('عذراً، حدث خطأ في معالجة الطلب.', 'bot');
    });
}

// إرسال الرسالة عند الضغط على Enter
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// الحصول على CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// التمرير التلقائي للأسفل
function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

// التمرير للأسفل عند تحميل الصفحة
window.addEventListener('load', function() {
    scrollToBottom();
    loadUserStats();
});

// تحميل إحصائيات المستخدم
function loadUserStats() {
    fetch('/chat/get-stats/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatsDisplay(data.stats);
        }
    })
    .catch(error => {
        console.error('Error loading stats:', error);
        // عرض إحصائيات افتراضية في حالة الخطأ
        showDefaultStats();
    });
}

// تحديث عرض الإحصائيات
function updateStatsDisplay(stats) {
    document.getElementById('completed-count').textContent = stats.completed_requests;
    document.getElementById('pending-count').textContent = stats.pending_requests;
    document.getElementById('total-count').textContent = stats.total_requests;
    
    // إضافة تأثيرات بصرية
    animateStats();
}

// عرض إحصائيات افتراضية
function showDefaultStats() {
    document.getElementById('completed-count').textContent = '0';
    document.getElementById('pending-count').textContent = '0';
    document.getElementById('total-count').textContent = '0';
}

// تأثيرات بصرية للإحصائيات
function animateStats() {
    const badges = document.querySelectorAll('.stats-section .badge');
    badges.forEach((badge, index) => {
        badge.style.opacity = '0';
        badge.style.transform = 'scale(0.8)';
        
        setTimeout(() => {
            badge.style.transition = 'all 0.5s ease';
            badge.style.opacity = '1';
            badge.style.transform = 'scale(1)';
        }, index * 200);
    });
}

// إضافة تأثير الكتابة للبوت
function addTypingIndicator() {
    const container = document.getElementById('messages-container');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-indicator';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-content">
            <div class="message-bubble bot-bubble">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-text">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

// إزالة مؤشر الكتابة
function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// تحسين إرسال الرسالة مع مؤشر الكتابة
function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content) return;
    
    // إضافة الرسالة للواجهة فوراً
    addMessageToUI(content, 'user');
    input.value = '';
    
    // إضافة مؤشر الكتابة
    addTypingIndicator();
    
    // إرسال الرسالة للخادم
    fetch('/chat/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        // إزالة مؤشر الكتابة
        removeTypingIndicator();
        
        if (data.success) {
            // إضافة رد البوت
            addMessageToUI(data.bot_response.content, 'bot', data.bot_response);
            
            // إذا كان هناك أزرار موافقة
            if (data.bot_response.show_approval_buttons) {
                currentChatRequestId = data.bot_response.chat_request_id;
                showApprovalButtons();
            }
        } else {
            addMessageToUI('عذراً، حدث خطأ. حاول مرة أخرى.', 'bot');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        console.error('Error:', error);
        addMessageToUI('عذراً، حدث خطأ في الاتصال.', 'bot');
    });
}

// تحسين إضافة الرسالة مع تأثيرات
function addMessageToUI(content, type, botResponse = null) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const now = new Date();
    const timeString = now.toLocaleTimeString('ar-EG', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (type === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble user-bubble">
                    <p>${content.replace(/\n/g, '<br>')}</p>
                    <small class="message-time">${timeString}</small>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble bot-bubble">
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-text">
                        <p>${content.replace(/\n/g, '<br>')}</p>
                        <small class="message-time">${timeString}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.appendChild(messageDiv);
    
    // تأثير الظهور
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
    }, 100);
    
    container.scrollTop = container.scrollHeight;
}
</script>
{% endblock %}
